FROM quay.io/keycloak/keycloak:latest as builder

RUN /opt/keycloak/bin/kc.sh build --db=mariadb

USER root
RUN microdnf install shadow-utils
RUN groupadd -r -g 112 ssl-cert
RUN usermod -a -G ssl-cert keycloak

FROM quay.io/keycloak/keycloak:latest

COPY --from=builder /opt/keycloak/ /opt/keycloak/
COPY --from=builder /etc/group /etc/group
COPY --from=builder /etc/passwd /etc/passwd

WORKDIR /opt/keycloak
ENTRYPOINT ["/opt/keycloak/bin/kc.sh"]