using AutoMapper;
using FS.TimeTracking.Abstractions.Interfaces.DTOs;
using FS.TimeTracking.Core.Interfaces.Application.Services.Shared;
using FS.TimeTracking.Core.Interfaces.Models;
using FS.TimeTracking.Core.Interfaces.Repository.Services.Database;
using FS.TimeTracking.Core.Models.Filter;
using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;

namespace FS.TimeTracking.Application.Services.Shared;

/// <inheritdoc />
public abstract class CrudModelService<TModel, TDto, TGridDto> : ICrudModelService<Guid, TDto, TGridDto>
    where TModel : class, IIdEntityModel, new()
    where TDto : class, IManageableDto
    where TGridDto : class, IManageableDto
{
    /// <summary>
    /// The repository.
    /// </summary>
    protected readonly IDbRepository DbRepository;

    /// <summary>
    /// The mapper to convert models to DTOs and vice versa.
    /// </summary>
    protected readonly IMapper Mapper;

    /// <inheritdoc cref="IFilterFactory"/>
    protected readonly IFilterFactory FilterFactory;

    /// <inheritdoc cref="IAuthorizationService"/>
    protected readonly IAuthorizationService AuthorizationService;

    /// <summary>
    /// Initializes a new instance of the <see cref="CrudModelService{TModel, TDto, TQuery}"/> class.
    /// </summary>
    /// <param name="authorizationService">The authorization service.</param>
    /// <param name="dbRepository">The repository.</param>
    /// <param name="mapper">The mapper to convert models to DTOs and vice versa.</param>
    /// <param name="filterFactory">The filter factory.</param>
    /// <autogeneratedoc />
    protected CrudModelService(IAuthorizationService authorizationService, IDbRepository dbRepository, IMapper mapper, IFilterFactory filterFactory)
    {
        AuthorizationService = authorizationService;
        DbRepository = dbRepository;
        Mapper = mapper;
        FilterFactory = filterFactory;
    }

    /// <inheritdoc />
    public virtual async Task<TDto> Get(Guid id, CancellationToken cancellationToken = default)
    {
        var dto = await DbRepository
            .FirstOrDefault<TModel, TDto>(
                where: model => model.Id == id,
                cancellationToken: cancellationToken
            );

        await AuthorizationService.SetAuthorizationRelatedProperties(dto, cancellationToken);

        return dto;
    }

    /// <inheritdoc />
    public abstract Task<List<TGridDto>> GetGridFiltered(TimeSheetFilterSet filters, CancellationToken cancellationToken = default);

    /// <inheritdoc />
    public virtual async Task<TGridDto> GetGridItem(Guid id, CancellationToken cancellationToken = default)
    {
        var dto = await DbRepository
            .FirstOrDefault<TModel, TGridDto>(
                where: model => model.Id == id,
                cancellationToken: cancellationToken
            );

        await AuthorizationService.SetAuthorizationRelatedProperties(dto, cancellationToken);

        return dto;
    }

    /// <inheritdoc />
    public virtual async Task<TDto> Create(TDto dto)
    {
        var model = Mapper.Map<TModel>(dto);
        await CheckConformity(model);
        var result = await DbRepository.Add(model);
        await DbRepository.SaveChanges();
        var resultDto = Mapper.Map<TDto>(result);
        await AuthorizationService.SetAuthorizationRelatedProperties(resultDto);
        return resultDto;
    }

    /// <inheritdoc />
    public virtual async Task<TDto> Update(TDto dto)
    {
        var model = Mapper.Map<TModel>(dto);
        await CheckConformity(model);
        var result = DbRepository.Update(model);
        await DbRepository.SaveChanges();
        var resultDto = Mapper.Map<TDto>(result);
        await AuthorizationService.SetAuthorizationRelatedProperties(resultDto);
        return resultDto;
    }

    /// <inheritdoc />
    public virtual async Task<long> Delete(Guid id)
    {
        var modelToRemove = new TModel { Id = id };
        DbRepository.Remove(modelToRemove);
        return await DbRepository.SaveChanges();
    }

    /// <summary>
    /// Checks conformity of an entity on a deeper level than model validation can do before it's added or modified to database.
    /// </summary>
    /// <param name="model">The model to check.</param>
    protected virtual Task CheckConformity(TModel model)
        => Task.CompletedTask;
}