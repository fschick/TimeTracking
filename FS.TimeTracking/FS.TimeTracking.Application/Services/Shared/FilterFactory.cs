using FS.FilterExpressionCreator.Enums;
using FS.FilterExpressionCreator.Extensions;
using FS.FilterExpressionCreator.Filters;
using FS.TimeTracking.Core.Constants;
using FS.TimeTracking.Core.Extensions;
using FS.TimeTracking.Core.Interfaces.Application.Services.Administration;
using FS.TimeTracking.Core.Interfaces.Application.Services.Shared;
using FS.TimeTracking.Core.Models.Application.Chart;
using FS.TimeTracking.Core.Models.Application.MasterData;
using FS.TimeTracking.Core.Models.Application.TimeTracking;
using FS.TimeTracking.Core.Models.Configuration;
using FS.TimeTracking.Core.Models.Filter;
using Microsoft.Extensions.Options;
using System.Linq;
using System.Threading.Tasks;

namespace FS.TimeTracking.Application.Services.Shared;

/// <inheritdoc />
public class FilterFactory : IFilterFactory
{
    private readonly IUserService _userService;
    private readonly TimeTrackingConfiguration _configuration;

    /// <summary>
    /// Initializes a new instance of the <see cref="FilterFactory"/> class.
    /// </summary>
    /// <param name="userService">The user service.</param>
    /// <param name="configuration">The configuration.</param>
    /// <autogeneratedoc />
    public FilterFactory(IUserService userService, IOptions<TimeTrackingConfiguration> configuration)
    {
        _userService = userService;
        _configuration = configuration.Value;
    }

    /// <inheritdoc />
    public Task<EntityFilter<Activity>> CreateActivityFilter(TimeSheetFilterSet filters)
    {
        var customerFilter = filters.CustomerFilter
            .Cast<Customer>()
            .Clear(x => x.Id);

        var projectFilter = filters.ProjectFilter
            .Cast<Project>()
            .Clear(x => x.Id);

        var filter = filters.ActivityFilter
            .Cast<Activity>()
            .Replace(x => x.CustomerId, filters.CustomerFilter.GetPropertyFilter(p => p.Id))
            .Replace(x => x.Customer, customerFilter)
            .Replace(x => x.ProjectId, filters.ProjectFilter.GetPropertyFilter(p => p.Id))
            .Replace(x => x.Project, projectFilter);

        return Task.FromResult(filter);
    }

    /// <inheritdoc />
    public Task<EntityFilter<Customer>> CreateCustomerFilter(TimeSheetFilterSet filters)
    {
        var filter = filters.CustomerFilter
            .Cast<Customer>();
        return Task.FromResult(filter);
    }

    /// <inheritdoc />
    public Task<EntityFilter<Order>> CreateOrderFilter(TimeSheetFilterSet filters)
    {
        var customerProjectFilter = filters.CustomerFilter
            .Cast<Customer>()
            .Clear(x => x.Id)
            .Replace(x => x.Projects, filters.ProjectFilter.Cast<Project>());

        var filter = filters.OrderFilter
            .Cast<Order>()
            .Replace(x => x.CustomerId, filters.CustomerFilter.GetPropertyFilter(c => c.Id))
            .Replace(x => x.Customer, customerProjectFilter);

        return Task.FromResult(filter);
    }

    /// <inheritdoc />
    public Task<EntityFilter<Project>> CreateProjectFilter(TimeSheetFilterSet filters)
    {
        var customerFilter = filters.CustomerFilter
            .Cast<Customer>()
            .Clear(x => x.Id);

        var filter = filters.ProjectFilter
            .Cast<Project>()
            .Replace(x => x.CustomerId, filters.CustomerFilter.GetPropertyFilter(c => c.Id))
            .Replace(x => x.Customer, customerFilter);

        return Task.FromResult(filter);
    }

    /// <inheritdoc />
    public async Task<EntityFilter<TimeSheet>> CreateTimeSheetFilter(TimeSheetFilterSet filters)
    {
        var customerFilter = filters.CustomerFilter
            .Cast<Customer>()
            .Clear(x => x.Id);

        var activityFilter = filters.ActivityFilter
            .Cast<Activity>()
            .Clear(x => x.Id);

        var projectFilter = filters.ProjectFilter
            .Cast<Project>()
            .Clear(x => x.Id);

        var orderFilter = filters.OrderFilter
            .Cast<Order>()
            .Clear(x => x.Id);

        var filter = filters.TimeSheetFilter
            .Cast<TimeSheet>()
            .Replace(x => x.CustomerId, filters.CustomerFilter.GetPropertyFilter(p => p.Id))
            .Replace(x => x.Customer, customerFilter)
            .Replace(x => x.ActivityId, filters.ActivityFilter.GetPropertyFilter(a => a.Id))
            .Replace(x => x.Activity, activityFilter)
            .Replace(x => x.ProjectId, filters.ProjectFilter.GetPropertyFilter(p => p.Id))
            .Replace(x => x.Project, projectFilter)
            .Replace(x => x.OrderId, filters.OrderFilter.GetPropertyFilter(o => o.Id))
            .Replace(x => x.Order, orderFilter);

        if (_configuration.Features.Authorization)
        {
            var filteredUsers = await _userService.GetFiltered(filters);
            var filteredUserIds = filteredUsers.Select(x => x.Id).ToArray();
            filter.Replace(x => x.UserId, filteredUserIds);
        }

        return filter;
    }

    /// <inheritdoc />
    public Task<EntityFilter<Holiday>> CreateHolidayFilter(TimeSheetFilterSet filters)
    {
        var filter = filters.HolidayFilter
            .Cast<Holiday>();

        return Task.FromResult(filter);
    }

    /// <inheritdoc />
    public async Task<ChartFilter> CreateChartFilter(TimeSheetFilterSet filters)
    {
        var workedTimesFilter = await CreateTimeSheetFilter(filters);
        var plannedTimesFilter = await CreateOrderFilter(filters);

        var selectedPeriodForFilter = await filters.GetSelectedPeriod();

        if (selectedPeriodForFilter.Start != DateOffset.MinDate)
            plannedTimesFilter = plannedTimesFilter
                .Replace(x => x.DueDate, FilterOperator.GreaterThanOrEqual, selectedPeriodForFilter.Start);

        if (selectedPeriodForFilter.End != DateOffset.MaxDate)
            plannedTimesFilter = plannedTimesFilter
                .Replace(x => x.StartDate, FilterOperator.LessThan, selectedPeriodForFilter.End);

        var selectedPeriod = await filters.GetSelectedPeriod(true);
        return new ChartFilter(workedTimesFilter, plannedTimesFilter, selectedPeriod);
    }
}