using FS.FilterExpressionCreator.Abstractions.Models;
using FS.TimeTracking.Abstractions.DTOs.Shared;
using FS.TimeTracking.Abstractions.Enums;
using FS.TimeTracking.Core.Extensions;
using FS.TimeTracking.Core.Interfaces.Application.Services.Administration;
using FS.TimeTracking.Core.Interfaces.Application.Services.Shared;
using FS.TimeTracking.Core.Interfaces.Repository.Services.Database;
using FS.TimeTracking.Core.Models.Application.MasterData;
using FS.TimeTracking.Core.Models.Filter;
using Nito.AsyncEx;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace FS.TimeTracking.Application.Services.Shared;
/// <inheritdoc />
public class WorkdayService : IWorkdayService
{
    private readonly ISettingApiService _settingService;
    private readonly AsyncLazy<List<Holiday>> _holidays;
    private readonly IUserService _userService;

    /// <summary>
    /// Initializes a new instance of the <see cref="WorkdayService" /> class.
    /// </summary>
    /// <param name="settingService">The setting service.</param>
    /// <param name="dbRepository">The repository.</param>
    /// <param name="userService">The user service.</param>
    /// <autogeneratedoc />
    public WorkdayService(ISettingApiService settingService, IDbRepository dbRepository, IUserService userService)
    {
        _settingService = settingService;
        _holidays = new AsyncLazy<List<Holiday>>(async () => await dbRepository.Get((Holiday x) => x));
        _userService = userService;
    }

    /// <inheritdoc />
    public async Task<WorkdaysDto> GetWorkdays(TimeSheetFilterSet filters, Range<DateTimeOffset> dateTimeRange, CancellationToken cancellationToken = default)
        => dateTimeRange != null
            ? await GetWorkdays(filters, dateTimeRange.Start.Date, dateTimeRange.End.Date, cancellationToken)
            : null;

    /// <inheritdoc />
    public async Task<WorkdaysDto> GetWorkdays(TimeSheetFilterSet filters, DateTime startDate, DateTime endDate, CancellationToken cancellationToken = default)
        => startDate <= endDate
            ? await GetWorkdays(filters, startDate.GetDays(endDate), cancellationToken)
            : new WorkdaysDto { PublicWorkdays = new(), PersonalWorkdays = new() };

    private async Task<WorkdaysDto> GetWorkdays(TimeSheetFilterSet filters, IEnumerable<DateTime> dates, CancellationToken cancellationToken = default)
    {
        var settings = await _settingService.GetSettings(cancellationToken);
        var holidays = await _holidays;

        var workdays = settings.Workdays
            .AsDictionary()
            .Where(x => x.Value)
            .Select(x => x.Key)
            .ToList();

        var publicHolidayDates = holidays
            .Where(x => x.Type == HolidayType.PublicHoliday)
            .SelectMany(x => x.StartDate.Date.GetDays(x.EndDate.Date))
            .Distinct();

        var publicWorkdays = dates
            .Where(date => workdays.Contains(date.DayOfWeek))
            .Except(publicHolidayDates)
            .ToList();

        var users = await _userService.GetFiltered(filters, cancellationToken).SelectAsync(x => x).ToListAsync();

        var publicWorkdaysPerUser = users
            .ToDictionary(
                user => user.Id,
                _ => publicWorkdays
            );

        var personalWorkdaysPerUser = users
            .ToDictionary(
                user => user.Id,
                user => GetPersonalWorkdaysForUser(user.Id, publicWorkdays, holidays)
            );

        return new WorkdaysDto
        {
            PublicWorkdays = publicWorkdaysPerUser,
            PersonalWorkdays = personalWorkdaysPerUser
        };
    }

    private static List<DateTime> GetPersonalWorkdaysForUser(Guid userId, List<DateTime> publicWorkdays, List<Holiday> holidays)
    {
        var personalHolidayDates = holidays
            .Where(x => x.Type == HolidayType.Holiday && x.UserId == userId)
            .SelectMany(x => x.StartDate.Date.GetDays(x.EndDate.Date))
            .Distinct();

        var personalWorkdays = publicWorkdays
            .Except(personalHolidayDates)
            .ToList();

        return personalWorkdays;
    }
}